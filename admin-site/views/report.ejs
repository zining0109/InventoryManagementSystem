<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report</title>
    <link rel="stylesheet" href="/css/report.css">
    <link rel="stylesheet" href="/css/menu.css">
    <link rel="icon" type="image/jpeg" href="/images/favicon.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".sidebar a");
    const currentPath = window.location.pathname;

    // First part after "/"
    let basePath = "/" + currentPath.split("/")[1];

    // Normalize mappings (group under parent menu)
    if (["/home"].includes(basePath)) {
      basePath = "/home";
    }
    if (["/item"].includes(basePath)) {
      basePath = "/inventory";
    }
    if (["/user", "/add-user", "/edit-user"].includes(basePath)) {
      basePath = "/user";
    }
    if (["/report"].includes(basePath)) {
      basePath = "/report";
    }
    if (["/history"].includes(basePath)) {
      basePath = "/history";
    }

    links.forEach(link => {
      if (link.getAttribute("href") === basePath) {
        link.classList.add("active");
      }
    });
  });
</script>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="menu">
      <ul>
        <li><a href="/home"><i class="bi bi-house"></i> Dashboard</a></li>
        <li><a href="/inventory"><i class="bi bi-boxes"></i> Inventory</a></li> 
        <li><a href="/user"><i class="bi bi-people"></i> User</a></li>
        <li><a href="/report"><i class="bi bi-bar-chart-line"></i> Report</a></li>
        <li><a href="/history"><i class="bi bi-clock-history"></i> History</a></li>
      </ul>
    </div>
    <div class="logout">
      <ul>
        <li><a href="/login"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content">
    <div class="container1">
      <h1>Inventory Management System <a href="/profile"><i class="bi bi-person-circle"></i></a></h1>
    </div>
    <hr>
    <div class="container2">
      <h2>Report
        <div class="custom-dropdown" id="filterDropdown" style="margin-left: 10px;">
          <i class="bi bi-list filter-icon" style="cursor: pointer;"></i>
        <div class="custom-dropdown-menu">
          <a href="#" data-report="stock-on-hand">Stock on Hand</a>
          <a href="#" data-report="stock-level">Stock Level</a>
          <a href="#" data-report="stock-movement">Stock Movement</a>
          <a href="#" data-report="inventory-flow">Inventory Flow</a>
          <a href="#" data-report="sales-report">Sales Report</a>
        </div>
        </div>
      </h2>
    </div>
    <hr>
    <h3 id="report-title" style="text-align: center;"></h3>
      <div class="date-filter" id="date-filter">
        <i class="bi bi-calendar2-fill calendar-icon" style="cursor:pointer; margin-left: 50%;"></i>
        <div class="date-menu">
          <form id="dateFilterForm" style="display: flex; flex-direction: column; gap: 8px; background-color: white;">
            <label>
              Start Date:
              <input type="date" name="start_date" id="start_date">
            </label>
            <label>
              End Date:
              <input type="date" name="end_date" id="end_date">
            </label>
            <button type="submit" class="btn btn-outline-primary">Apply</button>
          </form>
        </div>
      </div>
      <select id="itemSelect" onchange="updateInventoryFlow()" style="cursor:pointer; margin-left: 42.5%; margin-top: 20px;">
        <option value="">All Items</option>
      </select>
      <div class="month" id="monthInput">
        <label for="monthSelect"><strong>Select Month:</strong></label>
        <select id="monthSelect"></select>
      </div>
      <div class="report-layout">
      <!-- Row 1: Summary card -->
      <div id="salesSummary" class="card">
        <div class="card-header">Monthly Sales Summary</div>
        <div class="card-body">
          <table>
            <tbody>
              <tr>
                 <td>Total Sales Quantity</td>
                 <td id="totalSalesQty" style="text-align: right;"></td>
              </tr>
              <tr>
                <td>Revenue</td>
                <td id="totalRevenue" style="text-align: right;"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Row 2: Two pie charts side by side -->
      <div class="charts-row">
        <div class="card"  id="itemRevenuePieChart">
          <div class="card-header">Revenue by Item</div>
          <div class="card-body">
            <canvas id="itemRevenueChart"></canvas>
          </div>
        </div>
        <div class="card" id="categoryRevenuePieChart">
          <div class="card-header">Revenue by Category</div>
          <div class="card-body">
            <canvas id="categoryRevenueChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div id="report-container" style="margin-top: 20px; text-align: center; overflow-x: auto;">
    <div style="min-width: 800px;">
        <canvas id="reportChart" height="120"></canvas>
    </div>
    </div>
  </div>
<script>
  // Toggle dropdown
  const filterDropdown = document.getElementById("filterDropdown");
  const button = filterDropdown.querySelector(".filter-icon");

  button.addEventListener("click", (e) => {
    e.stopPropagation();
    filterDropdown.classList.toggle("show");
  });

  // Close dropdown if clicked outside
  document.addEventListener("click", () => {
    filterDropdown.classList.remove("show");
  });

  document.addEventListener("DOMContentLoaded", () => {
    // Always set default report here
    let defaultReport = "stock-on-hand";
    showReport(defaultReport);

  // Handle clicks on menu items
  document.querySelectorAll(".custom-dropdown-menu a").forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const reportType = link.dataset.report;
      showReport(reportType);
    });
  });
});

// One function to handle which report to show
function showReport(reportType) {
  document.getElementById("report-title").innerText = getReportTitle(reportType);

  const dateFilter = document.getElementById("date-filter");
  if (!dateFilter) return;

  // Reports that need date filter
  if (reportType === "stock-movement" || reportType === "stock-level" || reportType === "inventory-flow") {
    const { start, end } = setDefaultDates();

    if (reportType === "stock-movement") loadStockMovement(start, end);
    else if (reportType === "stock-level") loadStockLevel(start, end);
    else if (reportType === "inventory-flow") loadInventoryFlow(start, end);

    dateFilter.style.display = "block";
  } 
  else {
    dateFilter.style.display = "none";
    if (reportType === "stock-on-hand") loadStockOnHand();
    else if (reportType === "sales-report") {
      const select = document.getElementById("monthSelect");
      if (select.options.length === 0) {
        populateMonthDropdown();
      }
      const initialMonth = select.value;
      loadSalesReport(initialMonth);
    }
  }
}

// Helper function: map key -> display text
function getReportTitle(type) {
  switch(type) {
    case "stock-on-hand": return "Stock on Hand";
    case "stock-movement": return "Stock Movement";
    case "stock-level": return "Stock Level";
    case "inventory-flow": return "Inventory Flow";
    case "sales-report": return "Sales Report";
    default: return "Report";
  }
}

function loadStockOnHand() {
  document.getElementById("salesSummary").style.display = "none";
  document.getElementById("itemRevenuePieChart").style.display = "none";
  document.getElementById("categoryRevenuePieChart").style.display = "none";
  document.getElementById("monthInput").style.display = "none";
  document.getElementById("reportChart").style.display = "block";
  document.getElementById("itemSelect").style.display = "none";
  fetch("/api/report/stock-on-hand")
    .then(res => res.json())
    .then(data => {
      const labels = data.map(item => item.name);
      const quantities = data.map(item => item.quantity);

      const ctx = document.getElementById("reportChart").getContext("2d");

      if (window.reportChartInstance) {
        window.reportChartInstance.destroy(); // Reset chart if exists
      }

      window.reportChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Quantity",
            data: quantities,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { autoSkip: false }, // Show all item names
              title: { display: true, text: "Items" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Quantity in Stock"}
            }
          }
        },
        plugins: [{
          id: "lowStockDots",
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            data.datasets[0].data.forEach((value, index) => {
              if (value < 5) { // qty < 5
                const meta = chart.getDatasetMeta(0);
                const bar = meta.data[index];
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(bar.x, bar.y - 10, 5, 0, 2 * Math.PI);
                ctx.fill();
              }
            });
            ctx.restore();
          }
        }]
      });
    })
    .catch(err => {
      console.error("Failed to load stock on hand report:", err);
    });
}

function setDefaultDates() {
  const today = new Date();
  const end = today.toISOString().split("T")[0];
  const start = new Date(today);
  start.setDate(start.getDate() - 6);
  const startStr = start.toISOString().split("T")[0];

  document.getElementById("start_date").value = startStr;
  document.getElementById("end_date").value = end;

  return { start: startStr, end: end };
}

// ---- DATE MENU TOGGLE ----
document.addEventListener("DOMContentLoaded", () => {
  const calendarIcon = document.querySelector("#date-filter .calendar-icon");
  const dateMenu = document.querySelector("#date-filter .date-menu");

  if (!calendarIcon || !dateMenu) return;

  // Initially hidden
  dateMenu.style.display = "none";

  calendarIcon.addEventListener("click", (e) => {
    e.stopPropagation(); // Prevent closing immediately
    dateMenu.style.display = (dateMenu.style.display === "block") ? "none" : "block";
  });

  // Close menu if user clicks outside
  document.addEventListener("click", (e) => {
    if (!dateMenu.contains(e.target) && !calendarIcon.contains(e.target)) {
      dateMenu.style.display = "none";
    }
  });
});

// ---- DATE FILTER HANDLER ----
document.getElementById("dateFilterForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const start = document.getElementById("start_date").value;
  const end = document.getElementById("end_date").value;
  const currentReport = document.getElementById("report-title").innerText;
  const dateMenu = document.querySelector("#date-filter .date-menu");

  if (currentReport.includes("Stock Level")) {
    loadStockLevel(start, end);
  } else if (currentReport.includes("Stock Movement")) {
    loadStockMovement(start, end);
  } else if (currentReport.includes("Inventory Flow")) {     
    loadInventoryFlow(start, end);
  }

  if (dateMenu) dateMenu.style.display = "none"; // Safe close
});

function loadStockLevel(start_date, end_date) {
  document.getElementById("reportChart").style.display = "block";
  document.getElementById("salesSummary").style.display = "none";
  document.getElementById("itemRevenuePieChart").style.display = "none";
  document.getElementById("categoryRevenuePieChart").style.display = "none";
  document.getElementById("monthInput").style.display = "none";
  document.getElementById("itemSelect").style.display = "none";

  if (!end_date) {
    end_date = new Date().toISOString().split("T")[0];
  }
  if (!start_date) {
    const start = new Date(end_date);
    start.setDate(start.getDate() - 6);
    start_date = start.toISOString().split("T")[0];
  }

  fetch(`/api/report/stock-level?start_date=${start_date}&end_date=${end_date}`)
    .then(res => res.json())
    .then(rows => {
      if (!rows || rows.length === 0) {
        if (window.reportChartInstance) window.reportChartInstance.destroy();
        return;
      }

      // Build sorted date list from start_date..end_date (ensures consistent order)
      const dateList = [];
      const s = new Date(start_date);
      const e = new Date(end_date);
      for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
        // Format as yyyy-mm-dd to match backend
        dateList.push(d.toISOString().slice(0,10));
      }

      // Group stock_level by item (map date -> stock_level)
      const byItem = {};
      rows.forEach(r => {
        const name = r.name;
        if (!byItem[name]) byItem[name] = {};
        // ensure numeric
        const lvl = Number(r.stock_level);
        byItem[name][r.date] = isNaN(lvl) ? 0 : lvl;
      });

      // Create datasets; ensure every date has a value (fill forward if necessary)
      const colors = (n) => `hsl(${(n*47)%360}, 70%, 45%)`; // simple color generator
      const datasets = Object.keys(byItem).map((name, idx) => {
        const dateMap = byItem[name];
        const dataPoints = [];
        let last = null;
        dateList.forEach(d => {
          // If backend returned stock_level, use it; otherwise carry last value (flat)
          if (dateMap.hasOwnProperty(d)) {
            last = Number(dateMap[d]);
          }
          // If last is still null (no data before this date) set to 0
          const value = last === null ? 0 : last;
          dataPoints.push({ x: d, y: value });
        });
        return {
          label: name,
          data: dataPoints,
          borderColor: colors(idx),
          backgroundColor: colors(idx),
          fill: false,
          tension: 0.2,
          pointRadius: 3
        };
      });

      // Render chart
      const ctx = document.getElementById("reportChart").getContext("2d");
      if (window.reportChartInstance) window.reportChartInstance.destroy();
      window.reportChartInstance = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: {
            x: {
              type: "time",
              time: { unit: "day", tooltipFormat: "yyyy-MM-dd" },
              title: { display: true, text: "Date" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Stock Quantity" }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error("Failed to load stock level report:", err);
    });
}

function loadStockMovement(start_date, end_date) {
  document.getElementById("salesSummary").style.display = "none";
  document.getElementById("itemRevenuePieChart").style.display = "none";
  document.getElementById("categoryRevenuePieChart").style.display = "none";
  document.getElementById("monthInput").style.display = "none";
  document.getElementById("reportChart").style.display = "block";
  document.getElementById("itemSelect").style.display = "none";

  // If no dates passed → default last 7 days
  if (!end_date) {
    const today = new Date();
    end_date = today.toISOString().split("T")[0];
  }
  if (!start_date) {
    const start = new Date(end_date);
    start.setDate(start.getDate() - 6);
    start_date = start.toISOString().split("T")[0];
  }

  fetch(`/api/report/stock-movement?start_date=${start_date}&end_date=${end_date}`)
    .then(res => res.json())
    .then(data => {
      // Group by item → each line is an item
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.name]) grouped[row.name] = [];
        grouped[row.name].push({ x: row.date, y: row.movement });
      });

      const datasets = Object.keys(grouped).map((item, idx) => ({
        label: item,
        data: grouped[item],
        borderColor: `hsl(${idx * 50}, 70%, 50%)`,
        fill: false,
        tension: 0.2
      }));

      const ctx = document.getElementById("reportChart").getContext("2d");
      if (window.reportChartInstance) {
        window.reportChartInstance.destroy();
      }

      window.reportChartInstance = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" }
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "day",
                tooltipFormat: "yyyy-MM-dd"
              },
              title: { display: true, text: "Date" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Movement Quantity" }
            }
          }
        }
      });
    })
    .catch(err => console.error("Failed to load stock movement report:", err));
}

function updateInventoryFlow(start_date, end_date) {
  setTimeout(() => {
    const itemSelect = document.getElementById("itemSelect");
    if (!itemSelect) {
      console.warn("itemSelect not found — skipping updateInventoryFlow()");
      return;
    }

    const itemId = itemSelect.value || ""; // allow empty for "All Items"

    // Get date range from inputs or default to last 7 days
    const startInput = document.getElementById("start_date");
    const endInput = document.getElementById("end_date");

    let endDate = endInput?.value || new Date().toISOString().split("T")[0];
    let startDate = startInput?.value;
    if (!startDate) {
      const s = new Date(endDate);
      s.setDate(s.getDate() - 6);
      startDate = s.toISOString().split("T")[0];
    }

    // Build URL
    let url = `/api/report/inventory-flow?start_date=${startDate}&end_date=${endDate}`;
    if (itemId) url += `&item_id=${itemId}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        const labels = data.map(r => r.date);
        const inbound = data.map(r => r.inbound);
        const outbound = data.map(r => r.outbound);

        const ctx = document.getElementById("reportChart").getContext("2d");
        if (window.reportChartInstance) window.reportChartInstance.destroy();

        window.reportChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Inbound", data: inbound, backgroundColor: "rgba(75, 192, 192, 0.7)" },
              { label: "Outbound", data: outbound, backgroundColor: "rgba(255, 99, 132, 0.7)" }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              title: {
                display: true,
                text: itemId
                  ? "Inventory Flow (Inbound vs Outbound) — Selected Item"
                  : "Inventory Flow (Inbound vs Outbound) — All Items"
              }
            },
            scales: {
              x: { title: { display: true, text: "Date" } },
              y: { beginAtZero: true, title: { display: true, text: "Quantity" } }
            }
          }
        });
      })
      .catch(err => console.error("Failed to update inventory flow:", err));
  }, 100);
}

async function loadItemDropdown() {
  const res = await fetch("/api/items");
  const items = await res.json();
  const select = document.getElementById("itemSelect");
  items.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.id;
    opt.textContent = item.name;
    select.appendChild(opt);
  });
}

function loadInventoryFlow(start_date, end_date) {
  document.getElementById("reportChart").style.display = "block";
  document.getElementById("salesSummary").style.display = "none";
  document.getElementById("itemRevenuePieChart").style.display = "none";
  document.getElementById("categoryRevenuePieChart").style.display = "none";
  document.getElementById("monthInput").style.display = "none";
  document.getElementById("itemSelect").style.display = "block";

  const itemSelect = document.getElementById("itemSelect");
  if (!itemSelect) {
    console.warn("itemSelect element not found.");
    return;
  }

  // Load dropdown items if empty
  if (itemSelect.options.length <= 1) {
    loadItemDropdown().then(() => {
      setTimeout(updateInventoryFlow, 300);
    });
  } else {
    setTimeout(updateInventoryFlow, 300);
  }
}

const monthNames = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

function populateMonthDropdown() {
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth(); // 0-based

  // Example: show last 12 months
  for (let i = 0; i < 12; i++) {
    const date = new Date(currentYear, currentMonth - i, 1);
    const year = date.getFullYear();
    const month = date.getMonth();
    const value = `${year}-${String(month + 1).padStart(2, "0")}`;
    const option = document.createElement("option");
    option.value = value;
    option.textContent = `${monthNames[month]} ${year}`;
    if (i === 0) option.selected = true;
    select.appendChild(option);
  }
}

function loadSalesReport(monthYear) {
  document.getElementById("reportChart").style.display = "none";
  document.getElementById("salesSummary").style.display = "block";
  document.getElementById("itemRevenuePieChart").style.display = "block";
  document.getElementById("categoryRevenuePieChart").style.display = "block";
  document.getElementById("monthInput").style.display = "block";
  document.getElementById("itemSelect").style.display = "none";

  // Default to current month
  if (!monthYear) {
    const today = new Date();
    monthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;
  }

  const [year, month] = monthYear.split("-"); // Split correctly

  // Set dropdown
  const select = document.getElementById("monthSelect");
  select.value = monthYear;
  select.onchange = (e) => loadSalesReport(e.target.value);

  // Fetch from backend
  fetch(`/api/report/sales-report?month=${month}&year=${year}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("totalSalesQty").innerText = data.totalSalesQty;
      document.getElementById("totalRevenue").innerText =
        "RM " + Number(data.totalRevenue).toFixed(2);
      loadItemRevenueChart(data.itemRevenues);
      loadCategoryRevenueChart(data.categoryRevenues);
    })
    .catch(err => console.error("Failed to load sales report:", err));
}

function loadItemRevenueChart(itemRevenues) {
  const labels = itemRevenues.map(item => item.name);
  const values = itemRevenues.map(item => item.revenue);

  const ctx = document.getElementById("itemRevenueChart").getContext("2d");
  if (window.itemRevenueChartInstance) {
    window.itemRevenueChartInstance.destroy();
  }
  window.itemRevenueChartInstance = new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => `hsl(${i * 50}, 70%, 60%)`)
      }]
    },
    options: {
      plugins: {
        legend: { position: "right" },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: RM ${ctx.raw.toFixed(2)}`
          }
        }
      }
    }
  });
}

function loadCategoryRevenueChart(categoryRevenues) {
  const labels = categoryRevenues.map(cat => cat.name);
  const values = categoryRevenues.map(cat => cat.revenue);

  const ctx = document.getElementById("categoryRevenueChart").getContext("2d");
  if (window.categoryRevenueChartInstance) {
    window.categoryRevenueChartInstance.destroy();
  }
  window.categoryRevenueChartInstance = new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => `hsl(${i * 80}, 70%, 60%)`)
      }]
    },
    options: {
      plugins: {
        legend: { position: "right" },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.label}: RM ${ctx.raw.toFixed(2)}`
          }
        }
      }
    }
  });
}
</script>
</body>
</html>